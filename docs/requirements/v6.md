# Version 6 Requirements: Endgame-Strong Iterative Engine v17

This document defines the locked roadmap requirements for major version 6.

## Goal

Create `iterative engine v17` with significantly stronger endgame conversion and
mate behavior, without requiring external downloaded files, while preserving
UCI stability and compatibility with the humanized engine.

## Locked Clarifications

1. `v17` rollout strategy:
- Yes, roll out with A/B style progression initially (controlled mapping while validating).

2. Humanized dependency:
- `engine_humanized_v5` must switch to leverage `v17`.

3. KPK scope:
- Full exact logic now.

4. KBNK scope:
- True conversion logic now (not heuristic-only).

5. Performance budget:
- Up to `15%` NPS regression vs v16 is acceptable.

6. Endgame trigger scope:
- Conservative trigger only.

7. Draw-avoidance aggressiveness:
- Strong draw/repetition avoidance when clearly winning.

8. Candidate API exposure:
- Internal only (no Engine trait API expansion for this in v6).

9. Primary success metric:
- Fewer drawn won positions.

10. Delivery cadence:
- Minor version bump and git commit for each validated step.

## Functional Requirements

### 1) v17 Search/Eval Foundation

1. Add `engine_iterative_v17.rs` as a new engine implementation.
2. Keep `v16` intact for baseline comparison and rollback.
3. Preserve UCI output compatibility (`bestmove`, info lines, MultiPV semantics).

### 2) Mate and Conversion Policy Hardening

1. Tighten mate-distance shaping:
- prefer faster mate consistently,
- avoid score shaping that delays forced mate.
2. Add strong anti-repetition policy when winning:
- penalize repetition/draw drift in clearly favorable endgames.

### 3) Conservative Endgame Mode Trigger

1. Implement conservative endgame detection gate (low-material focused).
2. Activate endgame-specific search/eval behavior only when this gate is true.

### 4) Built-In KPK Exact Support (No External Files)

1. Implement exact king-and-pawn vs king logic/table embedded in code/repo.
2. Use it for decisive evaluation guidance in relevant positions.
3. Add fixed FEN tests for known KPK wins/draws.

### 5) KBNK True Logic

1. Implement true KBNK conversion logic (not only directional heuristics).
2. Ensure the engine can consistently drive the conversion plan.
3. Add regression tests for representative KBNK conversion positions.

### 6) Endgame Search Selectivity Tuning

1. In endgame mode, reduce over-aggressive pruning that hides forcing lines.
2. Add/adjust selective extensions for:
- forcing checks,
- king-pawn race critical lines,
- conversion-critical tactical nodes.
3. Tune quiescence/SEE thresholds for endgame tactical stability.

### 7) Internal Candidate Interface Stability

1. Keep candidate extraction API internal to engine/search layers.
2. Preserve data required by humanized engine:
- top candidate set,
- cp scores / comparable scoring context.

### 8) Humanized Engine Integration

1. Switch `engine_humanized_v5` backend dependency from v16-path to v17-path.
2. Preserve humanized behavior contract:
- CPL-budgeted selection remains functional,
- legal move behavior unchanged,
- no UCI-level option changes required.

## UCI and Mapping Requirements

1. Keep UCI option surface stable unless explicitly required for v6 internals.
2. Add/adjust skill-level mapping to allow A/B validation between v16 and v17.
3. Keep mappings deterministic and test-covered.

## Performance and Quality Constraints

1. Speed budget:
- v17 may be up to `15%` slower in NPS than v16 in exchange for stronger endgames.
2. Strength target:
- measurable reduction in drawn won positions on static endgame suite and
engine-match validation.

## Testing Requirements

### 1) Unit/Integration Coverage

1. Endgame trigger correctness tests.
2. KPK exact-case tests.
3. KBNK conversion tests.
4. Anti-repetition-while-winning tests.
5. Humanized-v5-on-v17 compatibility tests.
6. UCI mapping and output stability tests.

### 2) Endgame Validation Suite

1. Maintain curated static endgame FEN set including:
- KPK wins/draws,
- KBNK conversion positions,
- KRK/KQK conversion positions,
- mate-in-N endgames where applicable.
2. Track conversion outcomes and regression counts.

### 3) Acceptance Metric

Primary acceptance: fewer drawn won positions than v16 baseline under comparable
time/depth conditions.

## Delivery Plan (Stepwise, Versioned)

1. `v6.0`: Add v17 scaffold + mapping guardrails + baseline tests.
2. `v6.1`: Mate-score and repetition-while-winning hardening.
3. `v6.2`: Conservative endgame trigger framework.
4. `v6.3`: KPK exact support + tests.
5. `v6.4`: KBNK true logic + tests.
6. `v6.5`: Endgame selectivity tuning and extensions.
7. `v6.6`: Humanized engine switched to v17 backend.
8. `v6.7`: Validation pass, performance tuning, and final acceptance checks.
9. `v6.8`: Hash-consistency hardening for endgame helper probes (no side-flip state corruption) + regression tests.

Each step must:

1. pass targeted tests,
2. bump minor version,
3. commit to `dev`.
