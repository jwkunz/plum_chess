# Version 4 Requirements: True Multi-Threaded Search Transformation

This document reconstructs the major-version 4 requirements from the delivered
threading roadmap and implementation results.

## Goal

Transform Plum Chess from a primarily single-threaded search engine into a
practical multi-threaded engine with configurable behavior, robust fail-safety,
and measurable scaling.

## Threading Architecture Requirements

1. Introduce explicit threading contracts:
- threading model enum/config,
- worker count normalization,
- deterministic mode controls.
2. Add per-thread reusable context structures to avoid per-search setup churn.
3. Provide shared search-control state for worker coordination:
- shared stop signal,
- shared node/time budget accounting,
- shared search lifecycle reset hooks.

## Shared Data Requirements

1. Add thread-safe shared transposition-table (TT) fa√ßade.
2. Support TT sharding and generation aging in threaded contexts.
3. Provide shared TT stats visibility for diagnostics.
4. Ensure shared TT is reconfigured correctly when hash/thread settings change.

## Parallel Search Requirements

1. Implement parallel root move splitting under a Lazy SMP style model.
2. Integrate parallel root path into main best-move selection flow (not only
analysis-only paths).
3. Add dynamic work distribution (atomic queue) to improve load balancing over
static striding.
4. Add adaptive worker scaling for tiny time/node budgets to avoid overhead.
5. Preserve serial fallback behavior for unsupported or constrained cases.

## Safety and Determinism Requirements

1. Support deterministic mode that disables non-deterministic parallel behavior.
2. Add panic-safe fallback so worker panics do not hang the engine.
3. Guarantee stop propagation across workers under:
- explicit stop requests,
- shared node-budget exhaustion,
- shared time-budget exhaustion.

## UCI Integration Requirements

1. Expose threading controls via UCI options:
- `Threads`
- `ThreadingModel`
- `DeterministicSearch`
2. Add root parallel threshold controls:
- `RootParallelMinDepth`
- `RootParallelMinMoves`
3. Ensure options are applied consistently in:
- synchronous search path,
- asynchronous worker search path,
- rebuilt engine instances after strength changes.

## Telemetry and Observability Requirements

1. Emit threaded search markers for debugging and tuning:
- worker counts,
- split statistics,
- panic fallback usage,
- budget-stop indicators.
2. Emit shared TT diagnostics (probes/hits/stores and shard count).
3. Keep info output UCI-compatible and non-disruptive for GUIs.

## Benchmarking and Tuning Requirements

1. Provide a standalone thread scaling benchmark binary.
2. Benchmark across configurable:
- max threads,
- depth,
- run counts.
3. Use benchmark outputs to tune thread thresholds and workload balancing.

## Documentation Requirements

1. Maintain a dedicated v4 roadmap record in `docs/multithread_roadmap.md`.
2. Keep architecture docs synchronized with threaded engine reality.
3. Document recommended tuning loop for different time-control classes.

## Completion Criteria (Version 4)

Version 4 is considered complete when:

1. Multi-threaded root search is active and stable in normal play.
2. Thread controls are accessible and honored through UCI.
3. Shared budget/cancellation paths prevent runaway worker behavior.
4. Deterministic and panic-fallback paths are verified.
5. Scaling can be measured via the thread benchmark tooling.
