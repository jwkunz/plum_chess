# Version 7 Requirements: Search Performance Optimization (No External Tables)

This document defines the locked roadmap requirements for major version 7.

## Current Status (v7.9.0)

- Steps `v7.0` through `v7.9` are implemented.
- Baseline/performance tooling is available via `src/bin/v7_perf_baseline.rs`.
- Final measured behavior shows improved throughput on representative
  middlegame/tactical positions, with endgame conversion speed still identified
  as a known follow-up area.

## Goal

Increase search performance substantially while preserving engine stability and
without requiring external endgame/opening table files.

Primary objective:

- Raise practical throughput (NPS/depth reach) and reduce move latency.
- Preserve or improve tactical correctness and game strength.

## Hard Constraints

1. No external game tables or downloaded files.
2. Preserve UCI compatibility and option behavior unless explicitly versioned.
3. Keep humanized engine compatibility (v5 backend contracts remain valid).
4. No regression to hangs/stack overflows seen in previous versions.

## Performance Targets

1. Throughput target:
- `+25%` minimum NPS improvement vs v6.9 baseline in controlled runs.
- Stretch target: `+40%` to `+60%`.

2. Latency target:
- Reduce average move time in fixed-depth acceptance runs.

3. Stability target:
- Zero new search hangs in harness and UCI game play.

4. Strength guardrail:
- No material tactical collapse in fixed test suites.

## Functional Requirements

### 1) Search Hot Path De-allocation

1. Eliminate avoidable per-node allocations in search.
2. Reuse move buffers by ply where possible.
3. Avoid cloning full `GameState` in hot recursive paths unless unavoidable.

### 2) Make/Unmake Consolidation

1. Prefer `make_move_in_place`/`unmake_move_in_place` in search recursion.
2. Remove remaining apply/clone patterns in core node expansion.
3. Verify hash/state consistency invariants after migration.

### 3) Move Ordering Quality Pass

Ordering priority:

1. TT move
2. Tactical captures/promotions (SEE-aware)
3. Killer moves
4. Countermove / continuation history
5. Remaining quiets (history-ranked)

Requirements:

1. Tighten history saturation and normalization.
2. Keep ordering deterministic where deterministic mode is enabled.

### 4) Pruning/Reduction Retuning

1. Retune LMR table by `(depth, move_index, node_type)`.
2. Retune LMP guards for safer pruning.
3. Recheck null-move conditions and verification thresholds.
4. Add conservative reverse-futility where safe.

### 5) Quiescence Search Cost Control

1. Tighten qsearch branching with SEE/delta thresholds.
2. Keep forcing checks selective and capped.
3. Reduce tactical noise while preserving obvious tactical correctness.

### 6) TT and Cache Efficiency

1. Improve TT replacement policy quality (depth/age/bound priority).
2. Reduce shared-table contention under multi-threading.
3. Add cache-friendly layout adjustments where practical.

### 7) Parallel Search Scaling (Internal)

1. Improve root split scheduling.
2. Reduce synchronization overhead in shared state.
3. Keep deterministic behavior available as a mode.

### 8) Evaluation Incremental Cost Reduction

1. Reduce repeated recomputation in static eval components.
2. Add/expand cheap incremental terms where safe.
3. Preserve score semantics for existing engines.

### 9) Draw/Repetition Detection Cost Reduction

1. Reduce repetition-history scan overhead in hot paths.
2. Keep exact correctness of draw detection semantics.

### 10) Build and Runtime Profiling Discipline

1. Add explicit v7 benchmark workflow commands in docs.
2. Track each optimization step with before/after numbers.
3. Maintain reproducible benchmark settings.

## Testing Requirements

### 1) Correctness

1. Existing move-generation legality tests remain green.
2. Existing v6 endgame-specific tests remain green.
3. UCI-level smoke tests remain green.

### 2) Performance Validation

1. Controlled benchmark suite:
- perft speed slices
- fixed-depth tactical set
- engine match harness at fixed settings

2. Baseline comparison:
- v6.9 vs v7 candidate

3. Report:
- NPS delta
- avg move time delta
- draw/win/loss shifts in controlled matches

### 3) Acceptance

Version 7 is accepted when all are true:

1. >= `25%` NPS improvement vs v6.9 baseline in controlled benchmark mode.
2. No new instability failures (hang, overflow, deadlock) in acceptance runs.
3. No obvious tactical collapse in fixed test suites.

## Delivery Plan (Stepwise, Versioned)

1. `v7.0`: Benchmark baseline capture + instrumentation cleanup.
2. `v7.1`: Hot-path allocation removal and move-buffer reuse.
3. `v7.2`: Make/unmake search recursion consolidation.
4. `v7.3`: Move ordering retune (TT/SEE/killer/history stack).
5. `v7.4`: LMR/LMP/null-move/verification retune.
6. `v7.5`: Quiescence cost control pass.
7. `v7.6`: TT/cache/layout and contention improvements.
8. `v7.7`: Parallel scaling pass and synchronization tuning.
9. `v7.8`: Eval + repetition overhead reduction.
10. `v7.9`: Acceptance benchmarking and final stabilization.

Each step must:

1. pass targeted tests,
2. provide measured before/after notes,
3. bump minor version,
4. commit to `dev`.

## Clarifications To Confirm (Optional, Can Use Defaults)

If not specified, defaults will be used.

1. Baseline hardware for NPS claims:
- Default: your current dev machine only (single-machine relative metrics).

2. Preferred fixed benchmark depth/time controls:
- Default: depth-fixed for microbench, movetime-fixed for match harness.

3. Threading baseline for perf claims:
- Default: compare both `Threads=1` and your common GUI thread count.

4. Determinism priority:
- Default: keep deterministic mode behavior intact even if slightly slower.

5. Strength-vs-speed tradeoff tolerance:
- Default: allow minor Elo-neutral tactical shifts if speed gain is strong.
