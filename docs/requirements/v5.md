# Version 5 Requirements: Humanized CPL Engine

This document captures the locked requirements for major version 5.

## Goal

Create a new engine mode that emulates more human-like play quality and scales difficulty smoothly, using centipawn-loss (CPL) behavior from top root candidates.

## Difficulty Mapping

- Levels `3..=17`: use the new humanized CPL engine.
- Level `18`: use current best-move engine (`v16`) at depth `8`.
- Level `19`: use current best-move engine (`v16`) at depth `12`.
- Level `20`: use current best-move engine (`v16`) at depth `16`.

## Strength Percent Mapping

- Strength percent is linear from level `3` to `17`:
  - Level `3` -> `60%`
  - Level `17` -> `100%`

## Candidate Set and Evaluation Source

- Use root candidate scores from the **current search depth only**.
- Use top `3` root moves for CPL comparison.
- If fewer than `3` legal/root candidates are available, use the best move.

## CPL-Loss Targeting

- Compute CPL loss relative to the best root move.
- Use the confirmed baseline formula:
  - `allowed_cpl = max_cpl * (1 - percent)`
- Additional shaping requirements:
  - The **minimum** CPL bound must use a `sqrt(percent)` term.
  - The **maximum** CPL bound must use a `percent^2` term.

## Move Selection Policy

- Select among allowed candidates using **linear weighted random**.
- If no non-best candidate is inside CPL budget, pick the best move.

## Behavioral Constraints

- Apply humanization **after** opening-book handling.
- Keep the existing time-management strategy unchanged.
- Keep all tuning/config internal for now (no new UCI options required in this phase).

## Testing and Calibration

- Add tests using static test positions.
- Manual tuning and calibration will be done externally using a dedicated tuning binary/workflow.

